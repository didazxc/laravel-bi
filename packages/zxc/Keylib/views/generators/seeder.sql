insert into {{$keylib_dic_table}}
values
(100013,"IP多开","IP多开率（账号数量/IP数量）"),
(100012,"新增次留率","昨日新增今日仍活跃账号数/昨日新增账号数"),
(100011,"新增留存","新增留存账号数（昨日新增，今日仍活跃）"),
(100010,"新增","新增账号数"),
(100009,"回流","回流账号数（昨日未活跃，今日活跃且非今日新增）"),
(100008,"持续","持续账号数（昨日活跃，今日仍活跃）"),
(100007,"活跃","活跃账号数"),
(100006,"PCU","在线人数峰值"),
(100005,"ACU","平均在线人数"),
(100004,"消耗","消耗金额"),
(100003,"ARPU","付费金额/付费人数"),
(100002,"付费率","付费人数/付费金额"),
(100001,"付费人数","付费人数"),
(100000,"付费","付费金额")
;
INSERT INTO `zxc__key_lib_sql` (`id`, `sqlstr`, `key_id_json`, `conn`, `cron`, `sql_desc`, `created_at`, `updated_at`) VALUES
(1, 'select logtime\n  , cnt\n  , cnt_pc\n  , cnt_mb\n  , cnt_ad\n  , cnt_io\n\n  , pay\n  , pay_pc\n  , pay_mb\n  , pay_ad\n  , pay_io\n\n  , pay_cnt\n  , pay_cnt_pc\n  , pay_cnt_mb\n  , pay_cnt_ad\n  , pay_cnt_io\n\n  , pay_cnt*1.0/cnt pay_ratio\n  , pay_cnt_pc*1.0/cnt_pc pay_ratio_pc\n  , pay_cnt_mb*1.0/cnt_mb pay_ratio_mb\n  , pay_cnt_ad*1.0/cnt_ad pay_ratio_ad\n  , pay_cnt_io*1.0/cnt_io pay_ratio_io\n\n  , pay*1.0/pay_cnt arpu\n  , pay_pc*1.0/pay_cnt_pc arpu_pc\n  , pay_mb*1.0/pay_cnt_mb arpu_mb\n  , pay_ad*1.0/pay_cnt_ad arpu_ad\n  , pay_io*1.0/pay_cnt_io arpu_io\n\n  , expend\n  , expend_pc\n  , expend_mb\n  , expend_ad\n  , expend_io\nfrom\n(\nselect \n  $tflag_logtime logtime\n\n  ,count(distinct userid) cnt\n  ,count(distinct case when startsource in (1,3,5,7) then userid end) cnt_pc\n  ,count(distinct case when startsource>1 then userid end) cnt_mb\n  ,count(distinct case when startsource in (2,3,6,7) then userid end) cnt_ad\n  ,count(distinct case when startsource in (4,5,6,7) then userid end) cnt_io\n\n  ,sum(pay) pay\n  ,sum(pay_pc) pay_pc\n  ,sum(pay_ad+pay_io) pay_mb\n  ,sum(pay_ad) pay_ad\n  ,sum(pay_io) pay_io\n\n  ,count(distinct case when pay>0 then userid end) pay_cnt\n  ,count(distinct case when pay_pc>0 then userid end) pay_cnt_pc\n  ,count(distinct case when pay_ad+pay_io>0 then userid end) pay_cnt_mb\n  ,count(distinct case when pay_ad>0 then userid end) pay_cnt_ad\n  ,count(distinct case when pay_io>0 then userid end) pay_cnt_io\n\n  ,sum(expend)/1000 expend\n  ,sum(expend_pc)/1000 expend_pc\n  ,sum(expend_ad+expend_io)/1000 expend_mb\n  ,sum(expend_ad)/1000 expend_ad\n  ,sum(expend_io)/1000 expend_io\n\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime\n) as a', '{\n"cnt":{"key_id":"100007","terminal":"0"},\n"cnt_pc":{"key_id":"100007","terminal":"1"},\n"cnt_mb":{"key_id":"100007","terminal":"2"},\n"cnt_ad":{"key_id":"100007","terminal":"3"},\n"cnt_io":{"key_id":"100007","terminal":"4"},\n\n"pay":{"key_id":"100000","terminal":"0"},\n"pay_pc":{"key_id":"100000","terminal":"1"},\n"pay_mb":{"key_id":"100000","terminal":"2"},\n"pay_ad":{"key_id":"100000","terminal":"3"},\n"pay_io":{"key_id":"100000","terminal":"4"},\n\n"pay_cnt":{"key_id":"100001","terminal":"0"},\n"pay_cnt_pc":{"key_id":"100001","terminal":"1"},\n"pay_cnt_mb":{"key_id":"100001","terminal":"2"},\n"pay_cnt_ad":{"key_id":"100001","terminal":"3"},\n"pay_cnt_io":{"key_id":"100001","terminal":"4"},\n\n"pay_ratio":{"key_id":"100002","terminal":"0"},\n"pay_ratio_pc":{"key_id":"100002","terminal":"1"},\n"pay_ratio_mb":{"key_id":"100002","terminal":"2"},\n"pay_ratio_ad":{"key_id":"100002","terminal":"3"},\n"pay_ratio_io":{"key_id":"100002","terminal":"4"},\n\n"arpu":{"key_id":"100003","terminal":"0"},\n"arpu_pc":{"key_id":"100003","terminal":"1"},\n"arpu_mb":{"key_id":"100003","terminal":"2"},\n"arpu_ad":{"key_id":"100003","terminal":"3"},\n"arpu_io":{"key_id":"100003","terminal":"4"},\n\n"expend":{"key_id":"100004","terminal":"0"},\n"expend_pc":{"key_id":"100004","terminal":"1"},\n"expend_mb":{"key_id":"100004","terminal":"2"},\n"expend_ad":{"key_id":"100004","terminal":"3"},\n"expend_io":{"key_id":"100004","terminal":"4"}\n}', 'qq_sqlsrv', 7, '付费、消耗、付费人数、活跃、ARPU、付费率', '2016-02-18 04:51:05', '2016-05-04 09:24:40'),
(2, 'SELECT $tflag_minute logtime,max(value) PCU,AVG(value) ACU\nFROM\n(\nSELECT CONVERT(VARCHAR(16),[report_time],121) minute\n    ,sum([connect_count]) value\nFROM [ServerStatusLogDB_read].[dbo].[t_server_status_log_$_start_Ym] with (nolock)\nWHERE [report_time]>=''$startdate''\nAND [report_time]<''$enddate''\nAND [server_type_id]=1601\nGROUP BY CONVERT(VARCHAR(16),[report_time],121)\n) as a\nGROUP BY $tflag_minute\nORDER BY logtime;', '{\n"ACU":{"key_id":"100005"},\n"PCU":{"key_id":"100006"}\n}', 'qq_sqlsrv', 0, 'ACU、PCU', '2016-02-18 08:05:16', '2016-05-09 10:36:33'),
(3, '\nselect $tflag_logtime logtime\n,count(distinct userid) new_cnt\n,count(distinct case when startsource in (1,3,5,7) then userid end) new_cnt_pc\n,count(distinct case when startsource>1 then userid end) new_cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then userid end) new_cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then userid end) new_cnt_io\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime', '{\n"new_cnt":{"key_id":"100010","terminal":"0"},\n"new_cnt_pc":{"key_id":"100010","terminal":"1"},\n"new_cnt_mb":{"key_id":"100010","terminal":"2"},\n"new_cnt_ad":{"key_id":"100010","terminal":"3"},\n"new_cnt_io":{"key_id":"100010","terminal":"4"}\n}', 'qq_sqlsrv', 0, '新增', '2016-02-18 08:10:23', '2016-05-04 09:24:53'),
(4, 'IF OBJECT_ID(''tempdb.dbo.#keylib_last_new'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_last_new;\n\ncreate table #keylib_last_new(\nlogtime date not null,\nuserid bigint not null primary key(logtime,userid),\nstartsource tinyint not null,\nb_userid bigint null\n);\ncreate index idx_keylib_startsource on #keylib_last_new(startsource);\n\ninsert into #keylib_last_new\nselect a.logtime,a.userid,a.startsource,b.userid as b_userid\nfrom\n(select $tflag_logtime_last1 logtime\n,userid\n,startsource\nfrom QIQI_Stats.dbo.t_account_stat\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date'') as a\nleft join\n(select distinct $tflag_logtime logtime\n,userid\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate'') as b\non (a.logtime=b.logtime and a.userid=b.userid)\nwhere a.userid>0\n;\nselect logtime\n,new_live_cnt\n,new_live_cnt*1.0/new_cnt new_live_ratio\n,new_live_cnt_pc\n,new_live_cnt_pc*1.0/new_cnt_pc new_live_ratio_pc\n,new_live_cnt_mb\n,new_live_cnt_mb*1.0/new_cnt_mb new_live_ratio_mb\n,new_live_cnt_ad\n,new_live_cnt_ad*1.0/new_cnt_ad new_live_ratio_ad\n,new_live_cnt_io\n,new_live_cnt_io*1.0/new_cnt_io new_live_ratio_io\nfrom\n(\nselect logtime\n,count(distinct b_userid) new_live_cnt\n,count(distinct userid) new_cnt\n,count(distinct case when startsource in (1,3,5,7) then b_userid end) new_live_cnt_pc\n,count(distinct case when startsource in (1,3,5,7) then userid end) new_cnt_pc\n,count(distinct case when startsource>1 then b_userid end) new_live_cnt_mb\n,count(distinct case when startsource>1 then userid end) new_cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then b_userid end) new_live_cnt_ad\n,count(distinct case when startsource in (2,3,6,7) then userid end) new_cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then b_userid end) new_live_cnt_io\n,count(distinct case when startsource in (4,5,6,7) then userid end) new_cnt_io\nfrom \n#keylib_last_new\ngroup by logtime\n) as a', '{\n"new_live_cnt":{"key_id":"100011","terminal":"0"},\n"new_live_ratio":{"key_id":"100012","terminal":"0"},\n"new_live_cnt_pc":{"key_id":"100011","terminal":"1"},\n"new_live_ratio_pc":{"key_id":"100012","terminal":"1"},\n"new_live_cnt_mb":{"key_id":"100011","terminal":"2"},\n"new_live_ratio_mb":{"key_id":"100012","terminal":"2"},\n"new_live_cnt_ad":{"key_id":"100011","terminal":"3"},\n"new_live_ratio_ad":{"key_id":"100012","terminal":"3"},\n"new_live_cnt_io":{"key_id":"100011","terminal":"4"},\n"new_live_ratio_io":{"key_id":"100012","terminal":"4"}\n}', 'qq_sqlsrv', 7, '新增留存、新增留存率', '2016-02-18 08:17:03', '2016-05-04 09:27:05'),
(5, 'IF OBJECT_ID(''tempdb.dbo.#keylib_live'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live;\nIF OBJECT_ID(''tempdb.dbo.#keylib_live_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live_last;\n\nselect \n  $tflag_logtime logtime\n  ,userid\ninto #keylib_live\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate'';\n\nselect \n  $tflag_logtime_last1 logtime\n  ,userid\n  ,startsource\ninto #keylib_live_last\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date'';\n\nselect a.logtime\n,count(distinct a.userid) live_cnt\n,count(distinct case when a.startsource in (1,3,5,7) then a.userid end) live_cnt_pc\n,count(distinct case when a.startsource>1 then a.userid end) live_cnt_mb\n,count(distinct case when a.startsource in (2,3,6,7) then a.userid end) live_cnt_ad\n,count(distinct case when a.startsource in (4,5,6,7) then a.userid end) live_cnt_io\nfrom\n #keylib_live_last as a\njoin\n #keylib_live as b\non (a.logtime=b.logtime and a.userid=b.userid)\ngroup by a.logtime', '{\n"live_cnt":{"key_id":"100008","terminal":"0"},\n"live_cnt_pc":{"key_id":"100008","terminal":"1"},\n"live_cnt_mb":{"key_id":"100008","terminal":"2"},\n"live_cnt_ad":{"key_id":"100008","terminal":"3"},\n"live_cnt_io":{"key_id":"100008","terminal":"4"}\n}', 'qq_sqlsrv', 7, '持续', '2016-02-18 08:26:03', '2016-06-21 08:39:59'),
(6, 'IF OBJECT_ID(''tempdb.dbo.#keylib_active'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_active;\nIF OBJECT_ID(''tempdb.dbo.#keylib_new'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_new;\nIF OBJECT_ID(''tempdb.dbo.#keylib_active_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_active_last;\n\nselect \n  $tflag_logtime logtime\n  ,userid\n  ,startsource\ninto #keylib_active\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate'';\n\nselect \n  $tflag_logtime logtime\n  ,userid\ninto #keylib_new\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate'';\n\nselect \n  $tflag_logtime_last1 logtime\n  ,userid\ninto #keylib_active_last\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date'';\n\nselect a.logtime\n,count(distinct a.userid) back_cnt\n,count(distinct case when a.startsource in (1,3,5,7) then a.userid end) back_cnt_pc\n,count(distinct case when a.startsource>1 then a.userid end) back_cnt_mb\n,count(distinct case when a.startsource in (2,3,6,7) then a.userid end) back_cnt_ad\n,count(distinct case when a.startsource in (4,5,6,7) then a.userid end) back_cnt_io\nfrom\n #keylib_active as a\nleft join\n #keylib_new as b\non (a.logtime=b.logtime and a.userid=b.userid)\nleft join\n #keylib_active_last as c\non (a.logtime=c.logtime and a.userid=c.userid)\nwhere b.userid is null\nand c.userid is null\ngroup by a.logtime', '{\n"back_cnt":{"key_id":"100009","terminal":"0"},\n"back_cnt_pc":{"key_id":"100009","terminal":"1"},\n"back_cnt_mb":{"key_id":"100009","terminal":"2"},\n"back_cnt_ad":{"key_id":"100009","terminal":"3"},\n"back_cnt_io":{"key_id":"100009","terminal":"4"}\n}', 'qq_sqlsrv', 7, '回流', '2016-02-18 08:27:24', '2016-05-04 09:27:28'),
(7, 'IF OBJECT_ID(''tempdb.dbo.#t'', ''U'') IS NOT NULL\n  DROP TABLE #t;\nselect login_time logtime,userid,startsource,ip\ninto #t\nfrom login_stat_qq.dbo.t_tencent_user_login_record with (nolock)\nwhere login_time>=$_start_time\nand login_time<$_end_time\n;\nselect \n	logtime,cnt,ip_cnt,cnt*1.0/ip_cnt multip\n	,cnt_pc,ip_cnt_pc,cnt_pc*1.0/ip_cnt_pc multip_pc\n	,cnt_mb,ip_cnt_mb,cnt_mb*1.0/ip_cnt_mb multip_mb\n	,cnt_ad,ip_cnt_ad,cnt_ad*1.0/ip_cnt_ad multip_ad\n	,cnt_ios,ip_cnt_ios,cnt_ios*1.0/ip_cnt_ios multip_ios\nFROM\n(\nselect \n	$tflag_logtime_0_1 logtime\n	,count(distinct userid) cnt\n	,count(distinct ip) ip_cnt\n	,count(distinct  case when startsource not in (101,102) then userid end) cnt_pc\n	,count(distinct  case when startsource not in (101,102) then ip end) ip_cnt_pc\n	,count(distinct  case when startsource in (101,102) then userid end) cnt_mb\n	,count(distinct  case when startsource in (101,102) then ip end) ip_cnt_mb\n	,count(distinct case when startsource=101 then userid end) cnt_ad\n	,count(distinct case when startsource=101 then ip end) ip_cnt_ad\n	,count(distinct case when startsource=102 then userid end) cnt_ios\n	,count(distinct case when startsource=102 then ip end) ip_cnt_ios\nfrom #t\ngroup by $tflag_logtime_0_1\n) as a', '{\n"cnt":{"key_id":"100021","terminal":"0"},\n"ip_cnt":{"key_id":"100022","terminal":"0"},\n"multip":{"key_id":"100013","terminal":"0"},\n"cnt_pc":{"key_id":"100021","terminal":"1"},\n"ip_cnt_pc":{"key_id":"100022","terminal":"1"},\n"multip_pc":{"key_id":"100013","terminal":"1"},\n"cnt_mb":{"key_id":"100021","terminal":"2"},\n"ip_cnt_mb":{"key_id":"100022","terminal":"2"},\n"multip_mb":{"key_id":"100013","terminal":"2"},\n"cnt_ad":{"key_id":"100021","terminal":"3"},\n"ip_cnt_ad":{"key_id":"100022","terminal":"3"},\n"multip_ad":{"key_id":"100013","terminal":"3"},\n"cnt_ios":{"key_id":"100021","terminal":"4"},\n"ip_cnt_ios":{"key_id":"100022","terminal":"4"},\n"multip_ios":{"key_id":"100013","terminal":"4"}\n}', 'qq_sqlsrv', 0, 'ip多开', '2016-02-18 08:28:14', '2016-03-23 06:00:43'),
(8, 'SELECT CONVERT(VARCHAR(16),[report_time],121) logtime\n    ,sum(case when [server_type_id]=1601 then [connect_count] end) pcu\n    ,sum(case when [server_type_id]=1624 then [connect_count] end) star_pcu\nFROM [ServerStatusLogDB_read].[dbo].[t_server_status_log_$_Ym] with (nolock)\nWHERE [report_time]>=''$startdate''\nAND [report_time]<''$enddate''\nAND [server_type_id] in (1601,1624)\nGROUP BY CONVERT(VARCHAR(16),[report_time],121)\nORDER BY CONVERT(VARCHAR(16),[report_time],121)', '{\n"pcu":{"key_id":"100006","terminal":"0"},\n"star_pcu":{"key_id":"100015","terminal":"0"}\n}', 'qq_sqlsrv', 8, '实时在线', '2016-02-18 08:28:36', '2016-05-04 09:27:51'),
(9, 'SELECT logtime\n,count(userid) new_cnt\n,sum(mb) new_cnt_mb\n,count(userid)-sum(mb) new_cnt_pc\n,sum(ad) new_cnt_ad\n,sum(io) new_cnt_io\nFROM\n(\nSELECT DISTINCT CONVERT(VARCHAR(16),DATEADD(SECOND,[reg_time]/1000,''1970-01-01 08:00:00''),121) logtime,\n    [userid],\n    CASE\n        when ([startsource] in (101,102) or [sourcetype] in (101,102)) THEN 1\n        else 0\n    END mb,\n    CASE\n        when ([startsource] =101 or [sourcetype] =101) THEN 1\n        else 0\n    END ad,\n    CASE\n        when ([startsource] =102 or [sourcetype] =102) THEN 1\n        else 0\n    END io\nFROM [login_stat_qq].[dbo].[t_tencent_user_reg_record] with (nolock)\nwhere [reg_time]>=$_start_time\nand [reg_time]<$_end_time\n) as a\ngroup by logtime\norder by logtime;', '{\n"new_cnt":{"key_id":"100010","terminal":"0"},\n"new_cnt_pc":{"key_id":"100010","terminal":"1"},\n"new_cnt_mb":{"key_id":"100010","terminal":"2"},\n"new_cnt_ad":{"key_id":"100010","terminal":"3"},\n"new_cnt_io":{"key_id":"100010","terminal":"4"}\n}', 'qq_sqlsrv', 8, '实时新增', '2016-02-23 08:36:57', '2016-05-04 09:28:01'),
(10, 'SELECT logtime\n,sum(pay) pay\n,sum(pay_mb) pay_mb\n,sum(pay)-sum(pay_mb) pay_pc\n,sum(pay_ad) pay_ad\n,sum(pay_io) pay_io\nFROM\n(\n    SELECT [user_id] AS userid\n		,CONVERT(VARCHAR(16),DATEADD(SECOND,[pay_date]/1000,''1970-01-01 08:00:00''),121) as logtime\n		,[money_rmb_total]/10 as pay\n		,CASE\n		    WHEN [oem_id] in (1,2) THEN [money_rmb_total]/10\n		    ELSE 0\n		    END as pay_mb\n		,CASE\n		    WHEN [oem_id] =1 THEN [money_rmb_total]/10\n		    ELSE 0\n		    END as pay_ad\n		,CASE\n		    WHEN [oem_id] =2 THEN [money_rmb_total]/10\n		    ELSE 0\n		    END as pay_io\n	  from [guagua_order_qq].[dbo].[t_money_order] with (nolock)\n	  where [pay_date]>=$_start_time\n	  and [pay_date]<$_end_time\n	  and [order_status]=2\n	  and [pay_status]=2\n) as a\nGROUP BY logtime\nORDER BY logtime', '{\n"pay":{"key_id":"100000","terminal":"0"},\n"pay_pc":{"key_id":"100000","terminal":"1"},\n"pay_mb":{"key_id":"100000","terminal":"2"},\n"pay_ad":{"key_id":"100000","terminal":"3"},\n"pay_io":{"key_id":"100000","terminal":"4"}\n}', 'qq_sqlsrv', 8, '实时充值', '2016-02-23 08:57:25', '2016-02-23 09:04:33'),
(11, 'select logtime\n,sum(expend) expend\n,sum(expend_mb) expend_mb\n,sum(expend)-sum(expend_mb) expend_pc\n,sum(expend_ad) expend_ad\n,sum(expend_io) expend_io\nfrom\n(\n    select [USER_ID] userid\n		,CONVERT(VARCHAR(16),DATEADD(SECOND,[out_date]/1000,''1970-01-01 08:00:00''),121) as logtime\n		,[out_amount] as expend\n		,CASE\n		    WHEN [oem_id] IN (15,16) THEN [out_amount]\n		    ELSE 0\n		    END as expend_mb\n		,CASE\n		    WHEN [oem_id] =15 THEN [out_amount]\n		    ELSE 0\n		    END as expend_ad\n		,CASE\n		    WHEN [oem_id] =16 THEN [out_amount]\n		    ELSE 0\n		    END as expend_io\n		FROM [guagua_money_qq_read].[dbo].[t_user_money_out_detail] with (nolock)\n		where [out_date]>=$_start_time\n	    and [out_date]<$_end_time\n	    and user_id not between 10000 and 10010\n		and goods_count>0\nUNION ALL\n    select [USER_ID] userid\n		,CONVERT(VARCHAR(16),DATEADD(SECOND,[out_date]/1000,''1970-01-01 08:00:00''),121) as logtime\n		,[out_amount] as expend\n		,[out_amount] as expend_mb\n		,0 as expend_ad\n		,[out_amount] as expend_io\n	FROM [guagua_iosmoney_qq_read].[dbo].[t_user_money_out_detail] with (nolock)\n	where [out_date]>=$_start_time\n	and [out_date]<$_end_time\n	and user_id not between 10000 and 10010\n	and goods_count>0\n) as a\ngroup by logtime\norder by logtime', '{\n"expend":{"key_id":"100004","terminal":"0"},\n"expend_pc":{"key_id":"100004","terminal":"1"},\n"expend_mb":{"key_id":"100004","terminal":"2"},\n"expend_ad":{"key_id":"100004","terminal":"3"},\n"expend_io":{"key_id":"100004","terminal":"4"}\n}', 'qq_sqlsrv', 8, '实时消耗', '2016-02-23 09:00:56', '2016-05-04 09:28:16'),
(12, 'select logtime\n  , cnt_pc\n  , pay_cnt_pc*1.0/cnt_pc pay_ratio_pc\nfrom\n(\nselect \n  $tflag_logtime logtime\n  ,count(distinct case when startsource in (1,3,5,7) then userid end) cnt_pc\n  ,count(distinct case when pay_pc>0 then userid end) pay_cnt_pc\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime\n) as a', '{\n"cnt_pc":{"key_id":"100007","terminal":"1"},\n"pay_ratio_pc":{"key_id":"100002","terminal":"1"}\n}', 'qq_sqlsrv', 0, '各个端口纯活跃', '2016-03-03 02:18:42', '2016-05-04 09:28:26'),
(13, 'IF OBJECT_ID(''tempdb.dbo.#keylib_star_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_star_last;\nIF OBJECT_ID(''tempdb.dbo.#keylib_star'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_star;\nIF OBJECT_ID(''tempdb.dbo.#keylib_newstar_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_newstar_last;\n\nselect $tflag_logtime_last1 logtime,userid,sum(in_money) in_money\ninto #keylib_star_last\nfrom QIQI_Stats.dbo.t_star_stat_day with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\ngroup by $tflag_logtime_last1,userid\n;\nselect $tflag_logtime logtime,userid,sum(in_money) in_money\ninto #keylib_star\nfrom QIQI_Stats.dbo.t_star_stat_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime,userid\n;\n\nselect $tflag_logtime_last1 logtime,userid\ninto #keylib_newstar_last\nFROM(\nselect convert(char(10),dateadd(second,create_date/1000,''1970-01-01 08:00:00''),120) logtime\n	,uid userid\nfrom guagua_staruser_qq.dbo.t_staruser with (nolock)\nwhere create_date>=$_last_1_cycle_start_time\nand create_date<$_last_1_cycle_end_time) as a\n;\n\nselect a.logtime\n,count(distinct a.userid) cnt\n,count(distinct b.userid) live_cnt\n,count(distinct c.userid) new_live_cnt\n,sum(a.in_money) in_money\n,sum(case when b.userid is not null then a.in_money end) live_in_money\n,sum(case when c.userid is not null then a.in_money end) new_live_in_money\nfrom\n #keylib_star as a\nleft join\n #keylib_star_last as b\non (a.logtime=b.logtime and a.userid=b.userid)\nleft join\n#keylib_newstar_last c\non (a.logtime=c.logtime and a.userid=c.userid)\ngroup by a.logtime\norder by a.logtime', '{\n"cnt":{"key_id":"100015","terminal":"0"},\n"live_cnt":{"key_id":"100016","terminal":"0"},\n"new_live_cnt":{"key_id":"100019","terminal":"0"},\n"in_money":{"key_id":"100017","terminal":"0"},\n"live_in_money":{"key_id":"100026","terminal":"0"},\n"new_live_in_money":{"key_id":"100027","terminal":"0"}\n}', 'qq_sqlsrv', 7, '主播活跃、收入、上周期留存', '2016-03-03 11:34:49', '2016-05-04 09:23:10'),
(14, 'IF OBJECT_ID(''tempdb.dbo.#keylib_newstar'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_newstar;\nIF OBJECT_ID(''tempdb.dbo.#keylib_star'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_star;\n\nselect $tflag_logtime logtime,userid\ninto #keylib_newstar\nFROM(\nselect convert(char(10),dateadd(second,create_date/1000,''1970-01-01 08:00:00''),120) logtime\n	,uid userid\nfrom guagua_staruser_qq.dbo.t_staruser with (nolock)\nwhere create_date>=''$_start_time''\nand create_date<''$_end_time'') as a;\n\nselect $tflag_logtime logtime,userid,sum(in_money) in_money\ninto #keylib_star\nfrom QIQI_Stats.dbo.t_star_stat_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime,userid;\n\nselect a.logtime,count(distinct a.userid) new_cnt,sum(b.in_money) in_money\nfrom \n#keylib_newstar a\nleft join\n#keylib_star b\non (a.logtime=b.logtime and a.userid=b.userid)\ngroup by a.logtime\norder by a.logtime\n', '{\n"new_cnt":{"key_id":"100018"},\n"in_money":{"key_id":"100020"}\n}', 'qq_sqlsrv', 7, '主播新增、新增收入', '2016-03-03 12:09:39', '2016-05-04 09:22:19'),
(15, '\nselect \n  $tflag_logtime logtime\n  ,count(distinct userid) cnt\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource<>0\ngroup by $tflag_logtime', '{\n"cnt":{"key_id":"100021","terminal":"0"}\n}', 'qq_sqlsrv', 7, '仅登录表活跃数', '2016-03-16 02:50:36', '2016-05-04 09:22:02'),
(16, 'if object_id(''tempdb.dbo.#new'') is not null\ndrop table #new;\nif object_id(''tempdb.dbo.#act'') is not null\ndrop table #act;\nselect $tflag_logtime logtime,userid,startsource\ninto #new\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\n;\nselect $tflag_logtime logtime,userid,pay\ninto #act\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand pay>0\n;\nselect a.logtime\n	,count(distinct a.userid) new_cnt\n	,count(distinct b.userid) pay_cnt\n	,count(distinct b.userid)*1.0/count(distinct a.userid) pay_ratio\n	,sum(b.pay) pay\n	,count(distinct case when a.startsource=1 then a.userid end) new_cnt_pc\n	,count(distinct case when a.startsource=1 then b.userid end) pay_cnt_pc\n	,count(distinct case when a.startsource=1 then b.userid end)*1.0/count(distinct case when a.startsource=1 then a.userid end) pay_ratio_pc\n	,sum(case when a.startsource=1 then b.pay end) pay_pc\n	,count(distinct case when a.startsource in (2,4) then a.userid end) new_cnt_mb\n	,count(distinct case when a.startsource in (2,4) then b.userid end) pay_cnt_mb\n	,count(distinct case when a.startsource in (2,4) then b.userid end)*1.0/count(distinct case when a.startsource in (2,4) then a.userid end) pay_ratio_mb\n	,sum(case when a.startsource in (2,4) then b.pay end) pay_mb\n	,count(distinct case when a.startsource=2 then a.userid end) new_cnt_ad\n	,count(distinct case when a.startsource=2 then b.userid end) pay_cnt_ad\n	,count(distinct case when a.startsource=2 then b.userid end)*1.0/count(distinct case when a.startsource=2 then a.userid end) pay_ratio_ad\n	,sum(case when a.startsource=2 then b.pay end) pay_ad\n	,count(distinct case when a.startsource=4 then a.userid end) new_cnt_io\n	,count(distinct case when a.startsource=4 then b.userid end) pay_cnt_io\n	,count(distinct case when a.startsource=4 then b.userid end)*1.0/count(distinct case when a.startsource=4 then a.userid end) pay_ratio_io\n	,sum(case when a.startsource=4 then b.pay end) pay_io\nfrom\n#new a\nleft JOIN\n#act b\non a.logtime=b.logtime\nand a.userid=b.userid\ngroup by a.logtime', '{\n"new_cnt":{"key_id":"100010","terminal":"0"},\n"pay_cnt":{"key_id":"100024","terminal":"0"},\n"pay_ratio":{"key_id":"100025","terminal":"0"},\n"pay":{"key_id":"100023","terminal":"0"},\n"new_cnt_pc":{"key_id":"100010","terminal":"1"},\n"pay_cnt_pc":{"key_id":"100024","terminal":"1"},\n"pay_ratio_pc":{"key_id":"100025","terminal":"1"},\n"pay_pc":{"key_id":"100023","terminal":"1"},\n"new_cnt_mb":{"key_id":"100010","terminal":"2"},\n"pay_cnt_mb":{"key_id":"100024","terminal":"2"},\n"pay_ratio_mb":{"key_id":"100025","terminal":"2"},\n"pay_mb":{"key_id":"100023","terminal":"2"},\n"new_cnt_ad":{"key_id":"100010","terminal":"3"},\n"pay_cnt_ad":{"key_id":"100024","terminal":"3"},\n"pay_ratio_ad":{"key_id":"100025","terminal":"3"},\n"pay_ad":{"key_id":"100023","terminal":"3"},\n"new_cnt_io":{"key_id":"100010","terminal":"4"},\n"pay_cnt_io":{"key_id":"100024","terminal":"4"},\n"pay_ratio_io":{"key_id":"100025","terminal":"4"},\n"pay_io":{"key_id":"100023","terminal":"4"}\n}', 'qq_sqlsrv', 7, '新增付费', '2016-04-07 13:31:21', '2016-05-04 09:21:56'),
(17, 'IF OBJECT_ID(''tempdb.dbo.#keydis_game_temp1'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp1;\nIF OBJECT_ID(''tempdb.dbo.#keydis_game_temp2'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp2;\nIF OBJECT_ID(''tempdb.dbo.#keydis_game_temp3'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp3;\nIF OBJECT_ID(''tempdb.dbo.#keydis_game_temp4'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp4;\nIF OBJECT_ID(''tempdb.dbo.#keydis_game_temp5'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp5;\nIF OBJECT_ID(''tempdb.dbo.#keydis_game_temp6'', ''U'') IS NOT NULL\n  DROP TABLE #keydis_game_temp6;\nCREATE TABLE #keydis_game_temp1(\nlogtime date not null PRIMARY key,\ncut money not null\n);\nCREATE TABLE #keydis_game_temp2(\nlogtime date not null PRIMARY key,\ncut money not null\n);\nCREATE TABLE #keydis_game_temp3(\nlogtime date not null PRIMARY key,\nnpc_out money not null\n);\nCREATE TABLE #keydis_game_temp4(\nlogtime date not null PRIMARY key,\nnpc_out money not null\n);\nCREATE TABLE #keydis_game_temp5(\nlogtime date not null PRIMARY key,\nnpc_in money not null\n);\nCREATE TABLE #keydis_game_temp6(\nlogtime date not null PRIMARY key,\nnpc_in money not null\n);\nINSERT INTO #keydis_game_temp1\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([income_money])/1000 AS cut\nFROM [game_car_qiqi].[dbo].[t_system_brokerage] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nINSERT INTO #keydis_game_temp2\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([income_money])/1000 AS cut\nFROM [game_car_qiqi2].[dbo].[t_system_brokerage] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nINSERT INTO #keydis_game_temp3\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([outlay_amount])/1000 AS npc_out\nFROM [game_car_qiqi].[dbo].[t_user_out_detail_$yearmonth] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nAND user_type<>0\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nINSERT INTO #keydis_game_temp4\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([outlay_amount])/1000 AS npc_out\nFROM [game_car_qiqi2].[dbo].[t_user_out_detail_$yearmonth] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nAND user_type<>0\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nINSERT INTO #keydis_game_temp5\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([income_amount])/1000 AS npc_in\nFROM [game_car_qiqi].[dbo].[t_user_in_detail_$yearmonth] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nAND user_type<>0\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nINSERT INTO #keydis_game_temp6\nSELECT CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)  logtime,sum([income_amount])/1000 AS npc_in\nFROM [game_car_qiqi2].[dbo].[t_user_in_detail_$yearmonth] with (nolock)\nWHERE [create_time]>=$starttime\nAND [create_time]<$endtime\nAND user_type<>0\nGROUP BY CONVERT(VARCHAR(10),DATEADD(SECOND,[create_time]/1000,''1970-01-01 08:00:00''),120)\n;\nSELECT isnull(junior.logtime,middle.logtime) AS logtime\n    ,junior.cut\n        +middle.cut\n        +npc_in_junior.npc_in\n        +npc_in_middle.npc_in\n        -npc_out_junior.npc_out\n        -npc_out_middle.npc_out AS cut\nFROM #keydis_game_temp1 as junior\nfull outer JOIN #keydis_game_temp2 as middle\nON junior.logtime=middle.logtime\nfull outer JOIN #keydis_game_temp3 as npc_out_junior\nON junior.logtime=npc_out_junior.logtime\nfull outer JOIN #keydis_game_temp4 as npc_out_middle\nON junior.logtime=npc_out_middle.logtime\nfull outer JOIN #keydis_game_temp5 as npc_in_junior\nON junior.logtime=npc_in_junior.logtime\nfull outer JOIN #keydis_game_temp6 as npc_in_middle\nON junior.logtime=npc_in_middle.logtime', '{\n"cut":{"key_id":"100029","terminal":"0"}\n}', 'qq_sqlsrv', 0, '豪车漂移-每日利润', '2016-05-04 08:38:35', '2016-06-13 08:52:28'),
(18, '\n IF OBJECT_ID(''tempdb.dbo.#1'') IS NOT NULL\n  DROP TABLE #1;\nselect logtime,userid,startsource into #1\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\nselect $tflag_logtime logtime\n,count(distinct userid) new_cnt\n,count(distinct case when startsource in (1,3,5,7) then userid end) new_cnt_pc\n,count(distinct case when startsource>1 then userid end) new_cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then userid end) new_cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then userid end) new_cnt_io\nfrom #1\ngroup by $tflag_logtime', '{\n"new_cnt":{"key_id":"100030","terminal":"0"},\n"new_cnt_pc":{"key_id":"100030","terminal":"1"},\n"new_cnt_mb":{"key_id":"100030","terminal":"2"},\n"new_cnt_ad":{"key_id":"100030","terminal":"3"},\n"new_cnt_io":{"key_id":"100030","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常新增（仅移动限制ips<=50）', '2016-06-21 08:10:03', '2016-06-22 08:59:32'),
(19, 'select $tflag_logtime logtime\n,count(distinct userid) cnt\n,count(distinct case when startsource in (1,3,5,7) then userid end) cnt_pc\n,count(distinct case when startsource>1 then userid end) cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then userid end) cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then userid end) cnt_io\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand ips<=50\nand startsource<>0\ngroup by $tflag_logtime', '{\n"cnt":{"key_id":"100031","terminal":"0"},\n"cnt_pc":{"key_id":"100031","terminal":"1"},\n"cnt_mb":{"key_id":"100031","terminal":"2"},\n"cnt_ad":{"key_id":"100031","terminal":"3"},\n"cnt_io":{"key_id":"100031","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常活跃（ips<=50）', '2016-06-21 08:22:32', '2016-06-21 08:22:32'),
(20, '\n IF OBJECT_ID(''tempdb.dbo.#1'') IS NOT NULL\n  DROP TABLE #1;\nselect logtime,userid,startsource into #1\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom QIQI_Stats.dbo.t_account_stat with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\n\n\nIF OBJECT_ID(''tempdb.dbo.#keylib_last_new'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_last_new;\n\ncreate table #keylib_last_new(\nlogtime date not null,\nuserid bigint not null primary key(logtime,userid),\nstartsource tinyint not null,\nb_userid bigint null\n);\ncreate index idx_keylib_startsource on #keylib_last_new(startsource);\n\ninsert into #keylib_last_new\nselect a.logtime,a.userid,a.startsource,b.userid as b_userid\nfrom\n(select $tflag_logtime_last1 logtime\n,userid\n,startsource\nfrom #1\n) as a\nleft join\n(select distinct $tflag_logtime logtime\n,userid\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate'') as b\non (a.logtime=b.logtime and a.userid=b.userid)\nwhere a.userid>0\n;\nselect logtime\n,new_live_cnt\n,new_live_cnt*1.0/new_cnt new_live_ratio\n,new_live_cnt_pc\n,new_live_cnt_pc*1.0/new_cnt_pc new_live_ratio_pc\n,new_live_cnt_mb\n,new_live_cnt_mb*1.0/new_cnt_mb new_live_ratio_mb\n,new_live_cnt_ad\n,new_live_cnt_ad*1.0/new_cnt_ad new_live_ratio_ad\n,new_live_cnt_io\n,new_live_cnt_io*1.0/new_cnt_io new_live_ratio_io\nfrom\n(\nselect logtime\n,count(distinct b_userid) new_live_cnt\n,count(distinct userid) new_cnt\n,count(distinct case when startsource in (1,3,5,7) then b_userid end) new_live_cnt_pc\n,count(distinct case when startsource in (1,3,5,7) then userid end) new_cnt_pc\n,count(distinct case when startsource>1 then b_userid end) new_live_cnt_mb\n,count(distinct case when startsource>1 then userid end) new_cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then b_userid end) new_live_cnt_ad\n,count(distinct case when startsource in (2,3,6,7) then userid end) new_cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then b_userid end) new_live_cnt_io\n,count(distinct case when startsource in (4,5,6,7) then userid end) new_cnt_io\nfrom \n#keylib_last_new\ngroup by logtime\n) as a', '{\n"new_live_cnt":{"key_id":"100032","terminal":"0"},\n"new_live_ratio":{"key_id":"100033","terminal":"0"},\n"new_live_cnt_pc":{"key_id":"100032","terminal":"1"},\n"new_live_ratio_pc":{"key_id":"100033","terminal":"1"},\n"new_live_cnt_mb":{"key_id":"100032","terminal":"2"},\n"new_live_ratio_mb":{"key_id":"100033","terminal":"2"},\n"new_live_cnt_ad":{"key_id":"100032","terminal":"3"},\n"new_live_ratio_ad":{"key_id":"100033","terminal":"3"},\n"new_live_cnt_io":{"key_id":"100032","terminal":"4"},\n"new_live_ratio_io":{"key_id":"100033","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常新增次留（仅限制移动ips<=50）', '2016-06-21 08:28:50', '2016-06-22 08:39:22'),
(21, 'IF OBJECT_ID(''tempdb.dbo.#keylib_live'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live;\nIF OBJECT_ID(''tempdb.dbo.#keylib_live_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live_last;\n\nselect \n  $tflag_logtime logtime\n  ,userid\ninto #keylib_live\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource<>0;\n\nselect \n  $tflag_logtime_last1 logtime\n  ,userid\n  ,startsource\ninto #keylib_live_last\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand ips<=50\nand startsource<>0;\n\nselect a.logtime\n,count(distinct a.userid) live_cnt\n,count(distinct case when a.startsource in (1,3,5,7) then a.userid end) live_cnt_pc\n,count(distinct case when a.startsource>1 then a.userid end) live_cnt_mb\n,count(distinct case when a.startsource in (2,3,6,7) then a.userid end) live_cnt_ad\n,count(distinct case when a.startsource in (4,5,6,7) then a.userid end) live_cnt_io\nfrom\n #keylib_live_last as a\njoin\n #keylib_live as b\non (a.logtime=b.logtime and a.userid=b.userid)\ngroup by a.logtime', '{\n"live_cnt":{"key_id":"100034","terminal":"0"},\n"live_cnt_pc":{"key_id":"100034","terminal":"1"},\n"live_cnt_mb":{"key_id":"100034","terminal":"2"},\n"live_cnt_ad":{"key_id":"100034","terminal":"3"},\n"live_cnt_io":{"key_id":"100034","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常活跃次留', '2016-06-21 08:39:14', '2016-06-21 08:39:14'),
(22, '\n IF OBJECT_ID(''tempdb.dbo.#1'') IS NOT NULL\n  DROP TABLE #1;\nselect logtime,userid,startsource into #1\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\nselect $tflag_logtime logtime\n,count(distinct userid) cnt\n,count(distinct case when startsource in (1,3,5,7) then userid end) cnt_pc\n,count(distinct case when startsource>1 then userid end) cnt_mb\n,count(distinct case when startsource in (2,3,6,7) then userid end) cnt_ad\n,count(distinct case when startsource in (4,5,6,7) then userid end) cnt_io\nfrom #1\ngroup by $tflag_logtime', '{\n"cnt":{"key_id":"100035","terminal":"0"},\n"cnt_pc":{"key_id":"100035","terminal":"1"},\n"cnt_mb":{"key_id":"100035","terminal":"2"},\n"cnt_ad":{"key_id":"100035","terminal":"3"},\n"cnt_io":{"key_id":"100035","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常活跃（仅移动限制ips<=50）', '2016-06-21 10:06:15', '2016-06-21 10:06:49'),
(23, '\n IF OBJECT_ID(''tempdb.dbo.#1'') IS NOT NULL\n  DROP TABLE #1;\nselect logtime,userid,startsource into #1\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\n\n IF OBJECT_ID(''tempdb.dbo.#2'') IS NOT NULL\n  DROP TABLE #2;\nselect logtime,userid,startsource into #2\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\n\n\nIF OBJECT_ID(''tempdb.dbo.#keylib_live'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live;\nIF OBJECT_ID(''tempdb.dbo.#keylib_live_last'', ''U'') IS NOT NULL\n  DROP TABLE #keylib_live_last;\n\nselect \n  $tflag_logtime logtime\n  ,userid\ninto #keylib_live\nfrom  #1;\n\nselect \n  $tflag_logtime_last1 logtime\n  ,userid\n  ,startsource\ninto #keylib_live_last\nfrom #2\nwhere logtime>=''$_last_1_cycle_start_date''\nand logtime<''$_last_1_cycle_end_date'';\n\nselect a.logtime\n,count(distinct a.userid) live_cnt\n,count(distinct case when a.startsource in (1,3,5,7) then a.userid end) live_cnt_pc\n,count(distinct case when a.startsource>1 then a.userid end) live_cnt_mb\n,count(distinct case when a.startsource in (2,3,6,7) then a.userid end) live_cnt_ad\n,count(distinct case when a.startsource in (4,5,6,7) then a.userid end) live_cnt_io\nfrom\n #keylib_live_last as a\njoin\n #keylib_live as b\non (a.logtime=b.logtime and a.userid=b.userid)\ngroup by a.logtime', '{\n"live_cnt":{"key_id":"100036","terminal":"0"},\n"live_cnt_pc":{"key_id":"100036","terminal":"1"},\n"live_cnt_mb":{"key_id":"100036","terminal":"2"},\n"live_cnt_ad":{"key_id":"100036","terminal":"3"},\n"live_cnt_io":{"key_id":"100036","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常活跃次留（仅移动限制ips<=50）', '2016-06-21 10:11:00', '2016-06-22 03:34:15'),
(24, '\n IF OBJECT_ID(''tempdb.dbo.#1'') IS NOT NULL\n  DROP TABLE #1;\nselect logtime,userid,startsource into #1\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (1,3,5,7)\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (2,3,6,7)\nand ips<=50\nunion all\nselect logtime,userid,startsource\nfrom [QIQI_Stats].[dbo].[t_account_status_day] with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\nand startsource in (4,5,6,7)\nand ips<=50;\n\n\nselect a.logtime\n  , pay_cnt*1.0/cnt pay_ratio\n  , pay_cnt_pc*1.0/cnt_pc pay_ratio_pc\n  , pay_cnt_mb*1.0/cnt_mb pay_ratio_mb\n  , pay_cnt_ad*1.0/cnt_ad pay_ratio_ad\n  , pay_cnt_io*1.0/cnt_io pay_ratio_io\n  from  \n(\nselect \n  $tflag_logtime logtime\n  ,count(distinct case when pay>0 then userid end) pay_cnt\n  ,count(distinct case when pay_pc>0 then userid end) pay_cnt_pc\n  ,count(distinct case when pay_ad+pay_io>0 then userid end) pay_cnt_mb\n  ,count(distinct case when pay_ad>0 then userid end) pay_cnt_ad\n  ,count(distinct case when pay_io>0 then userid end) pay_cnt_io\n\nfrom QIQI_Stats.dbo.t_account_status_day with (nolock)\nwhere logtime>=''$startdate''\nand logtime<''$enddate''\ngroup by $tflag_logtime\n) a join \n\n(\nselect \n  $tflag_logtime logtime\n\n  ,count(distinct userid) cnt\n  ,count(distinct case when startsource in (1,3,5,7) then userid end) cnt_pc\n  ,count(distinct case when startsource>1 then userid end) cnt_mb\n  ,count(distinct case when startsource in (2,3,6,7) then userid end) cnt_ad\n  ,count(distinct case when startsource in (4,5,6,7) then userid end) cnt_io\n\nfrom #1\ngroup by $tflag_logtime\n) b on a.logtime=b.logtime ', '{\n"pay_ratio":{"key_id":"100037","terminal":"0"},\n"pay_ratio_pc":{"key_id":"100037","terminal":"1"},\n"pay_ratio_mb":{"key_id":"100037","terminal":"2"},\n"pay_ratio_ad":{"key_id":"100037","terminal":"3"},\n"pay_ratio_io":{"key_id":"100037","terminal":"4"}\n}', 'qq_sqlsrv', 7, '正常付费率（仅限制移动ips<=50）', '2016-06-22 07:53:02', '2016-06-22 08:10:08');
